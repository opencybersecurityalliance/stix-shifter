# Datadog
Datadog is a data observability service for cloud-scale applications, providing monitoring of servers, databases, tools, and services, through a SaaS-based data analytics platform.
An event represents any record of activity noteworthy for engineers (devs, ops, and security).
This is a connector for searching events generated by its infrastructure and the associated monitors. 
For more information about endpoint for querying event stream in datadog see https://docs.datadoghq.com/api/latest/events/#query-the-event-stream.

### Format for making STIX translation calls via the CLI

`python main.py <translator_module> <query or result> <STIX identity object> <data>`

Note the STIX identity object is only used when translating data source results into STIX, so it can be passed in as an empty object for query translation calls.

### Converting from STIX patterns to Datadog queries

This example input pattern for TRANSLATE:

`python main.py translate datadog query '{}' "[domain-name:value = 'abc.com']"`

Returns the following search query:

```
{
    "queries": [
        "{\"query\": {\"host\": \"abc.com\", \"start\": 12344778, \"end\": 12345678}, \"source\": \"events\"}",
        "{\"query\": {\"host\": \"abc.com\", \"start\": 12344778, \"end\": 12345678}, \"source\": \"processes\"}"
    ]
}
```

### Converting from Datadog events to STIX

Datadog data to STIX mapping is defined in `to_stix_map.json`

This example Datadog data:

Dialect: events
`python3 main.py translate datadog results '{"type": "identity", "id": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3", "name": "datadog", "identity_class": "events"}' '[{
                "date_happened": 1628017283,
                "alert_type": "info",
                "title": "An API key has been created.",
                "url": "/event/event?id=6102786433786642502",
                "text": "API key getevents created by qradar10.34.38.141@gmail.com in org qradar",
                "tags": [
                    "account",
                    "audit"
                ],
                "device_name": "windows-GS-2190",
                "priority": "normal",
                "host": "i-deadbeef",
				"resource": "/api/event/6102786433786642502",
                "id": 6102786433786642502
            }]'`

Will return the following STIX observable:

```json
{
    "type": "bundle",
    "id": "bundle--2cded6c0-e4be-4130-bafe-5fed3fd77cea",
    "spec_version": "2.0",
    "objects": [
        {
            "type": "identity",
            "id": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3",
            "name": "datadog",
            "identity_class": "events"
        },
        {
            "id": "observed-data--4d8d91fe-acec-4c3a-9933-a80ab987a490",
            "type": "observed-data",
            "created_by_ref": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3",
            "created": "2021-10-27T04:41:26.710Z",
            "modified": "2021-10-27T04:41:26.710Z",
            "objects": {
                "0": {
                    "type": "x-ibm-finding",
                    "time_observed": "1970-01-19T21:23:43.438Z"
                },
                "1": {
                    "type": "x-oca-event",
                    "created": "1970-01-19T21:23:43.438Z",
                    "outcome": "A new application key has been created.",
                    "original_ref": "3",
                    "code": 6173353997162745223
                },
                "2": {
                    "type": "x-datadog-event",
                    "alert_type": "info",
                    "tags": [
                        "account",
                        "audit"
                    ],
                    "priority": "normal"
                },
                "3": {
                    "type": "artifact",
                    "payload_bin": "QXBwbGljYXRpb24ga2V5IFdpbmRvd3MgY3JlYXRlZCBieSBxcmFkYXIxNDFAeWFob28uY29tIGluIG9yZyBRcmFkYXI="
                }
            },
            "first_observed": "1970-01-19T21:23:43.438Z",
            "last_observed": "1970-01-19T21:23:43.438Z",
            "number_observed": 1
        }
    ]
}
```

Dialect: processes
`python3 main.py translate datadog results '{"type": "identity", "id": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3", "name": "datadog", "identity_class": "events"}' '[{
            "cmdline": "System",
            "timestamp": "2021-10-27T04:56:31",
            "start": "2021-04-11T02:35:56",
            "user": "NT AUTHORITY\\SYSTEM",
            "pid": 4,
            "ppid": 0,
            "host": "win10vm4",
            "tags": [
                "host:win10vm4",
                "user:NT_AUTHORITY\\SYSTEM",
                "command:System",
                "state_zombie:false"
            ]
        }]'`

Will return the following STIX observable:

```json
{
    "type": "bundle",
    "id": "bundle--f2a6f293-b84b-4544-b94c-8fc34424597e",
    "spec_version": "2.0",
    "objects": [
        {
            "type": "identity",
            "id": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3",
            "name": "datadog",
            "identity_class": "events"
        },
        {
            "id": "observed-data--af6f4917-7147-460d-8b93-e990e735ff82",
            "type": "observed-data",
            "created_by_ref": "identity--3532c56d-ea72-48be-a2ad-1a53f4c9c6d3",
            "created": "2021-10-27T05:01:14.803Z",
            "modified": "2021-10-27T05:01:14.803Z",
            "objects": {
                "0": {
                    "type": "process",
                    "command_line": "System",
                    "created_time": "2021-10-27T04:56:31",
                    "creator_user_ref": "2",
                    "pid": 4
                },
                "1": {
                    "type": "x-ibm-finding",
                    "start": "2021-04-11T02:35:56"
                },
                "2": {
                    "type": "user-account",
                    "user_id": "NT AUTHORITY\\SYSTEM"
                },
                "3": {
                    "type": "domain-name",
                    "value": "win10vm4"
                },
                "5": {
                    "type": "x-datadog-event",
                    "tags": [
                        "host:win10vm4",
                        "user:NT_AUTHORITY\\SYSTEM",
                        "command:System",
                        "state_zombie:false"
                    ]
                }
            },
            "first_observed": "2021-10-27T05:01:14.803Z",
            "last_observed": "2021-10-27T05:01:14.803Z",
            "number_observed": 1
        }
    ]
}
```

## Transmit

### Transmit functions

Transmit offers several functions: ping, query, results and is_async.

### Ping

Uses the data source API to ping the connection

CLI command example:
```
python3 main.py transmit datadog '{"site_url": <site_url>}' '{ "auth": { "api_key": <api_key>, "application_key": <application_key>}}' ping
```
If connection establish returns the following response:
```
{
    "success": true
}
```

### Query

Queries the data source API with the translated query and returns the search id

CLI command example:
```
python3 main.py transmit datadog '{"site_url": <site_url>}' '{ "auth": { "api_key": <api_key>, "application_key": <application_key>}}' query "{\"query\": {\"tags\": \"account\", \"start\": 1627207221, \"end\": 1629972021}, \"source\": \"events\"}"
```

If successful, will return the following response:
```
{
    "success": true,
    "search_id": <search_id>
}
```

### Results

Uses the data source API to fetch the query results based on the search ID, offset, and length.

CLI Command example for events dialect:
```
python3 main.py transmit datadog '{"site_url": <site_url>}' '{ "auth": { "api_key": <api_key>, "application_key": <application_key>}}' results "{\"query\": {\"tags\": \"account\", \"start\": 1627207221, \"end\": 1629972021}, \"source\": \"events\"}" <OFFSET> <LENGTH>
```
Returns following result
```json
{
    "success": true,
    "data": [
        {
            "date_happened": 1628017898,
            "alert_type": "info",
            "title": "A new application key has been created.",
            "url": "/event/event?id=6102796743464967547",
            "text": "Application key test created by qradar10.34.38.141@gmail.com in org qradar",
            "tags": [
                "account",
                "audit"
            ],
            "device_name": null,
            "priority": "normal",
            "host": "i-deadbeef",
            "id": 6102796743464967547
        }
    ]
}
```

CLI Command example for processes dialect:
```
python3 main.py transmit datadog '{"site_url": <site_url>}' '{ "auth": { "api_key": <api_key>, "application_key": <application_key>}}' results "{\"query\": {\"pid\": 92, \"start\": 1627207221, \"end\": 1629972021}, \"source\": \"processes\"}" <OFFSET> <LENGTH>
```
Returns following result
```json
{
    "success": true,
    "data": [
        {
            "cmdline": "Registry",
            "timestamp": "2021-10-20T05:56:21",
            "start": "2021-04-11T02:35:44",
            "user": "NT AUTHORITY\\SYSTEM",
            "pid": 92,
            "ppid": 4,
            "host": "win10vm4",
            "tags": [
                "host:win10vm4",
                "user:NT_AUTHORITY\\SYSTEM",
                "command:Registry",
                "state_zombie:false"
            ]
        }
    ]
}
```

### Execute

This command executes translation and transmission of the query to the data source and returns STIX Observable mappings
defined in the `to_stix_map.json` file.

CLI Command example for events dialect:
```
python3 main.py execute datadog:events datadog:events '{"type": "identity","id": "identity--f431f809-377b-45e0-aa1c-6a4751cae5ff","name": "datadog","identity_class": "events"}' {"site_url": <site_url>}' '{ "auth": { "api_key": <api_key>, "application_key": <application_key>}}' "[x-datadog-event:tags = 'account'] START t'2021-09-19T00:00:00.000Z' STOP t'2021-09-24T00:00:00.000Z'"
```

If successful, will return the following response
```
{
    "queries": [
        "{\"query\": {\"tags\": \"account\", \"start\": 1632009600, \"end\": 1632441600}, \"source\": \"events\"}"
    ]
}
STIX Results:
{
    "type": "bundle",
    "id": "bundle--406fe952-7021-474e-942c-4d65d1d1cc8b",
    "objects": [
        {
            "type": "identity",
            "id": "identity--f431f809-377b-45e0-aa1c-6a4751cae5ff",
            "name": "datadog",
            "identity_class": "events"
        },
        {
            "id": "observed-data--2cf24fcc-7fcb-4b73-a5ee-440dcfa9b1d7",
            "type": "observed-data",
            "created_by_ref": "identity--f431f809-377b-45e0-aa1c-6a4751cae5ff",
            "created": "2021-10-20T06:16:46.411Z",
            "modified": "2021-10-20T06:16:46.411Z",
            "objects": {
                "0": {
                    "type": "x-ibm-finding",
                    "time_observed": "1970-01-19T21:23:43.438Z"
                },
                "1": {
                    "type": "x-oca-event",
                    "created": "1970-01-19T21:23:43.438Z",
                    "outcome": "A new application key has been created.",
                    "original_ref": "3",
                    "code": 6173353997162745223
                },
                "2": {
                    "type": "x-datadog-event",
                    "alert_type": "info",
                    "tags": [
                        "account",
                        "audit"
                    ],
                    "priority": "normal"
                },
                "3": {
                    "type": "artifact",
                    "payload_bin": "QXBwbGljYXRpb24ga2V5IFdpbmRvd3MgY3JlYXRlZCBieSBxcmFkYXIxNDFAeWFob28uY29tIGluIG9yZyBRcmFkYXI="
                }
            },
            "first_observed": "1970-01-19T21:23:43.438Z",
            "last_observed": "1970-01-19T21:23:43.438Z",
            "number_observed": 1
        }
}
```

CLI Command example for processes dialect:
```
python3 main.py execute datadog:processes datadog:processes '{"type": "identity","id": "identity--f431f809-377b-45e0-aa1c-6a4751cae5ff","name": "datadog","identity_class": "events"}' {"site_url": <site_url>}' '{ "auth": { "api_key": <api_key>, "application_key": <application_key>}}' "[domain-name:value = 'win10vm4'] START t'2021-09-19T00:00:00.000Z' STOP t'2021-09-24T00:00:00.000Z'"
```

If successful, will return the following response
```
{
    "queries": [
        "{\"query\": {\"host\": \"win10vm4\", \"start\": 1632009600, \"end\": 1632441600}, \"source\": \"processes\"}"
    ]
}
STIX Results:
{
    "type": "bundle",
    "id": "bundle--0549813e-69ea-4eac-94e8-af9bd87165db",
    "objects": [
        {
            "type": "identity",
            "id": "identity--f431f809-377b-45e0-aa1c-6a4751cae5ff",
            "name": "datadog",
            "identity_class": "events"
        },
        {
            "id": "observed-data--db254f5d-6d9d-4b0e-a280-5f3835e006ba",
            "type": "observed-data",
            "created_by_ref": "identity--f431f809-377b-45e0-aa1c-6a4751cae5ff",
            "created": "2021-10-20T06:30:29.372Z",
            "modified": "2021-10-20T06:30:29.372Z",
            "objects": {
                "0": {
                    "type": "process",
                    "command_line": "Registry",
                    "created_time": "2021-10-20T06:29:51",
                    "creator_user_ref": "2",
                    "pid": 92
                },
                "1": {
                    "type": "x-ibm-finding",
                    "start": "2021-04-11T02:35:44"
                },
                "2": {
                    "type": "user-account",
                    "user_id": "NT AUTHORITY\\SYSTEM"
                },
                "3": {
                    "type": "domain-name",
                    "value": "win10vm4"
                },
                "5": {
                    "type": "x-datadog-event",
                    "tags": [
                        "host:win10vm4",
                        "user:NT_AUTHORITY\\SYSTEM",
                        "command:Registry",
                        "state_zombie:false"
                    ]
                }
            },
            "first_observed": "2021-10-20T06:30:29.372Z",
            "last_observed": "2021-10-20T06:30:29.372Z",
            "number_observed": 1
        }
}
```